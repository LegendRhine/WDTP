# Write Down, Then Publish (WDTP)
 
 立项日期：2016-09-02

 ### 项目简介

- 四大主要功能：
    1. 网站（博客）内容管理，静态网页生成与发布
    2. 电子笔记、备忘录与日记本
    3. （图书、教程、文档、信函、小说、剧本等）构思规划、写作编辑、文档管理、定制排版与生成
	4. 本机文本文档管理器

- 五大主要特色：
    1. 跨平台运行，Windows、MacOS、Linux、Android平板、iOS（iPad）通吃，所有平台下的程序功能、操作方式、控件布局、界面外观等等完全一致
    2. 专注于记录与写作，最大程度提高工作效率。写作方式采用简化的 Markdown 文本标记语法，易学易用
	3. 排版与渲染结果依托于可自由定制并扩展性极强的模板系统
    4. 绿色软件，轻灵小巧，强悍高效，简洁先进
    5. 开源项目，所有用户下载并编译源码后均可永久性免费使用（需遵循GPL v2协议）

### 代码目录结构
- Source
	- 目录
		- BinaryData（二进制资源）
		- Gui（GUI界面方面的类）
		- InnerProcess（数据处理和业务逻辑方面的类）
	- 文件
		- Main.cpp
		- MainComponent类
		- SwingLookAndFeel类
		- SwingUtilities类
		- WdtpHeader.h
  
### 用户端磁盘目录结构

- 项目文件夹 （该文件夹由用户创建或指定）
	- 项目文件.wdtp （文件名由用户指定）
	- docs (保存Markdown格式的文本文档，用户创建项目时自动生成，名称不可更改)
		- index.md
		- media（Docs目录下的文档所链接的图像、音视频等媒体文件存放于此）
		- 子文件夹...
			- 文档1.md
			- 文档2.md
			- media（"子文件夹"目录下的文档所链接的图像、音视频等媒体文件存放于此）
			- ...
	- site (保存渲染生成后的网页。结构与Docs完全一致，文件扩展名为html)
		- media（网站根目录下的网页所链接的图像、音视频等媒体文件存放于此）
		- index.html
		- style.css
		- 子文件夹...
			- media（网站"子文件夹"目录下的网页所链接的图像、音视频等媒体文件存放于此）
			- 文章1.html
			- 文章2.html
			- ...
	- themes (模板文件夹，每套模板位于一个独立的子文件夹下)
		- default （系统默认模板）
			- index.html （文件名和扩展名可为任意，但必须保证是文本文件，最好为UTF-8格式）
			- page.html
			- article.html
			- category.html
			- 404.html
		- theme-2 （模板2）
			- ...

- docs、site、themes这三个文件夹由用户创建新项目时自动生成，这三个文件夹的名称不可变
- Docs文件夹**必须**与项目文件位于同一个父目录下
- 程序所创建、管理的所有 Markdown 文档必须位于Docs目录或其某个子目录下，文件扩展名定死为“.md”
- 项目采用哪套模板渲染，由用户设置。设置办法：指定Themes下的某个子文件夹。设置结果（子文件夹名称）记录在项目文件中
- 某个文档也可以单独设置所用的渲染模板，参见文档结构的doc子树类型的相关属性

### 系统设置
- PropertiesFile (systemFile, 系统属性文件)位于本机“用户-文档”目录下，文件名为：wdtp.sys，属性如下：
	- recentFiles：最近打开的10个项目
	- language: 界面语言（字符串，语言名称）
	- uiBackground: 界面背景色
	- uiTextColour: 界面文字只有深浅两种颜色，根据UI颜色的亮度确定
	- fontName: 文本编辑器所用的字体(暂未使用)
	- fontSize：文本编辑器的字体大小
	- editorFontColour: 文本编辑器文字颜色
	- editorBackground: 文本编辑器背景色

### 项目文档
- 项目文档（*.wdtp）采用ValueTree数据模型+TreeView视图+派生的TreeViewItem实现文档的组织管理、显示与交互等功能。
- 项目文档的内部结构（值树结构）同磁盘目录树。
- 下表所描述的“值树类型”为创建ValueTree对象时的Identifier名称，该名称可由ValueTree::getType()获悉

- wdtpProject（总值树类型，相当于该项目磁盘目录的Docs），属性见下
	- dir（子树类型，代表磁盘Docs下的某个目录），属性见下
		- dir（子树类型，代表磁盘Docs下某个目录下的二级子目录）
			- doc（子树类型，代表磁盘上的某个二级子目录下的 Markdown 文档）  
			- doc  
		- doc（子树类型，代表Docs下某个一级目录下的 Markdown 文档） 
		- doc  
	- dir
		- doc 
		- doc  
	- doc（子树类型，代表磁盘目录Docs下的某个 Markdown 文档）
	- doc（子树类型，代表磁盘目录Docs下的某个 Markdown 文档）

- 由上面的值树结构可知，文档值树结构完全对应磁盘目录结构，但不含每个磁盘目录下的media文件夹，也不含Docs之外的任何磁盘文件夹
- 项目文档的ValueTree总值树中，dir树既可以有子dir树（目录），也可以有doc树（文档）。而doc树则不能有任何dir和doc
- 项目文档的ValueTree中，可将doc文档子树直接作为总值树的一级子树（代表于磁盘Docs目录下的某个 Markdown 文档文件）

- wdtpProject总值树的属性（项目属性）：
    - name: 值为“site”
    - tile: 项目名称
	- keywords: 关键字
    - description: 简述
	- owner: 项目所有者（作者）
	- contact 对应模板文件中的{{contact}}
	- copyright: 显示在网页页底的版权信息
	- order: 文件树的排序方式。文件名（0）、标题/简介（1）、网页文件名（2）、文件大小（3）、创建时间（4）、修改时间（5）
	- dirFirst: 目录排在前面（0），还是文档排在前面（1）
	- ascending: 升序(0)还是降序(1)
	- showWhat: TreeView中显示文件名（0）、标题/简介（1），还是网页文件名（2）
	- tooltip：TreeView中的tooltip显示文件名（包括所有路径，0）、标题/简介（1），还是网页文件名（2）
	- render: 模板目录（磁盘Themes下的某个子目录，即已安装的某套模板）
	- tplFile: 渲染网站首页所使用的模板文件，位于render所设置的目录下
	- js: 首页所需的js代码
	- ad: 广告代码（任意html代码），对应模板文件中的标签{{ad}}
    - modifyDate: 最后一次修改的日期
	- needCreateHtml: 本站根目录下的index.html是否需要生成
	- identityOfLastSelectedItem: 文件树中最后一次选择的文档的标示，可由TreeView的findItemFromIdentifierString()找到对应的item，
	  此值用于文件树中移动项目、打开项目时自动选择最后一次点选的item

- 值树中各个dir（目录）的属性：
    - name：目录名 (不包含任何上级路径。上级路径可通过其父节点的name获取）
	- title：标题，即网页上所显示的栏目名称
	- keywords: 关键字
    - description: 目录简述，用于index的description
	- createDate: 创建日期
    - modifyDate: 最后一次修改的日期
	- isMenu：是否为网站菜单
	- tplFile: 渲染目录index页所使用的模板文件，位于项目属性render所设置的目录下
	- js: 目录index页所需的js代码
	- needCreateHtml: 本目录下的index.html是否需要生成

- 值树中各个doc（文档）的属性：
    - name：文件名（不含文件扩展名，不包含任何上级路径。上级路径可通过其父节点的name获取）
	- title：文章或页面的标题
	- keywords: 关键字
    - description: 简述，用于index的description
	- createDate: 创建日期
    - modifyDate: 最后一次修改的日期
	- isMenu: 本文挡是否为网站菜单（不加入列表页。其模板则可以是articel，也可以是page）。注意：作为网站菜单的文档必须位于根目录下
	- tplFile: 渲染本文档所使用的模板文件，位于项目属性render所设置的目录下
	- js: 网页所需的js代码
	- thumb: bool值，目录index页面中是否提取并显示本文档中的第一幅图片（标题图）
	- thumbName: 标题图的文件名, 带有“media/”前缀（防止不带时无法定位其他目录media下的图像）
	- needCreateHtml: 本文档是否需要生成网页

- MD文档生成html时，替换模板html中的“标签项”（格式为：{{xxxx}}），要替换的项目如下：
    - {{siteRelativeRootPath}} 该网页相对于网站根目录的路径，用于该网页链接网站根目录下的css样式表文件。
	  比如：当前网页的地址是：“site/dir/subDir/00.html”  则该值应该是：“../../../”。注意：最后一定是“/”
	  此标签可用于<head>区中连接外部css文件等情况
	- {{keywords}} <head>区meta属性中的的关键字
	- {{description}} <head>区meta属性中的描述，即：MD文档中有实际内容的第二段（标题后面的非空行段落）
	- {{title}} <head>区meta属性中的标题，即：MD文档的第一行（标题）
	- {{contentTitle}} <body>区文章或目录的标题
	- {{content}} <body>区中所显示的网页内容，即：MD文档的所有内容
	- {{siteLogo}} 显示网站LOGO图片，图片位于网站根目录add-in文件夹下，文件名为logo.png
	- {{siteMenu}} 网站主菜单
	- {{siteNavi}} 当前页面的导航菜单
	- {{createAndModifyTime}} 创作及最后修改时间
	- {{previousAndNext}} 上一篇，下一篇
	- {{ad}} 广告代码，在项目根目录中设置. 格式：“图像文件名 链接地址”。图像文件应位于site/add-in目录下
	- {{random}} 随机推荐5篇本站文章
	- {{contact}} 联系方式
	- {{toTop}} 点击后回到页面顶端
	- {{bottomCopyright}} 每页页底的版权信息

	- {{titleOfDir}} <body>区中所显示的当前目录的标题
	- {{fileAndDirList_Y_N-Y_10}} <body>区中所显示的文章/目录列表，倒序（新的在上），不含目录，含描述，每页显示10条
	- {{fileAndDirList_N_Y_N_0}} <body>区中所显示的文章/目录列表，正序，含目录，不含描述，不分页（一页内显示全部）
	- {{fileAndDirList_N_N_Y_0}} <body>区中所显示的文章/目录列表，正序，不含目录，含描述，不分页（一页内显示全部）

	// 以下尚未实现
	- {{fileAndDirList_Y_Y_N_0}} <body>区中所显示的文章/目录列表，倒序，含目录，不含描述，不分页（一页内显示全部）
	- {{fileAndDirList_N_N_Y_10}} <body>区中所显示的文章/目录列表，正序，不含目录，含描述，每页显示10条

### 界面设计

- 主界面分上下两部分。上半部分为顶部工具栏，占空间比例较小。
    1. 工具栏左右两端为两个搜索文本框（左：全局搜索，右：当前文档内搜索）
	2. 工具栏中间部分为图标式按钮，以实现几个常用操作，最右侧按钮点击后可弹出系统菜单	

- 主界面下半部分为工作区，占空间较大，垂直三栏式（可拖拽调整每一栏的宽度）。从左至右：
    1. 文档管理面板（文档浏览器），右键菜单中包括与之相关的所有功能
	2. 文档写作与编辑区（TextEditor），文档渲染效果的预览区（WebComponent）。二者同一时间只显示其一
	3. 属性面板区。根据文档管理面板的当前所选，显示并设置与之相关的各类属性

### 业务逻辑（工作流、具体功能）

- 初次启动，一片空白。新建项目，程序自动创建：项目文件，docs目录，docs/media目录，themes目录及默认的css与模板文件
- 新建或打开已有项目后，左侧的文件浏览面板显示该项目的TreeView
- 导入外部 Markdown 文档：将外部文档复制到当前项目的所选文件夹下（docs根目录或某个子目录）
- 项目另存时，如果要另存的文档已经存在，则可选“覆盖，但保留原文档的项目属性”，要保留的即是上述项目属性
- 外部文本文件纳入本项目时，复制至此。纳入后，改扩展名为“.md”。可导入的格式：
	- *.md
	- *.markdown
	- *.txt
	- *.html
	- *.htm

- 可将所选的某个文档、某个目录或整个项目导出为一个MD文档（右键菜单-导出）
- 导出的MD文档内容为：**按当前排序结果依次追加**所选目录（整个项目）的所有MD文档。因此，不同的排序方式影响导出后的文档内容
- 删除所选的条目，对应的磁盘文件（目录）移至操作系统回收站
- 预览当前文档时，自动生成该文档对应的html网页文件
- 预览某个目录或项目根目录时，自动生成并预览该目录下的index网页文件
- 启动后进入预览状态，而不是编辑状态。此时工具栏预览按钮点亮
- 点选文档后，进入何种状态由工具栏预览按钮确定
- 新建文档后，自动进入编辑状态。此时工具栏预览按钮熄灭


### 关于排序

- 项目文件中的条目不进行排序，每次新建目录或文档，自动添加到当前节点（项目树或各级目录树）的最前面
- 文件浏览面板视图中的条目显示的顺序，由 DocTreeViewItem 类内部完成（内存中对子项目排序并按该顺序显示在界面中）
- 用户新建目录或文档后，显示排序后的结果。所用的排序方式为当前所采用的（右键菜单）

### 用户须知

- 新建项目时，最好提前在磁盘上创建一个新的空白文件夹，而后将项目文件保存到该文件夹下
- 本站范围内的文章链接，尽量不要使用域名前缀，而是采用相对路径。特别是菜单项的链接地址
- 项目属性中可设置文档渲染所用的模板，因此，采用项目文件另存为的方式，可实现同一套文档分别生成不同风格的多个网站
  （生成后可分别发布到多个远程主机），也可利用这一点，将某些或全部文档生成为其他格式的电子文档
- style.css必须位于site目录下
- 文件名不能是“media”


